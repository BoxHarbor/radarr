name: Test All Platforms

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      radarr_version:
        description: 'Radarr version to test'
        required: false

env:
  IMAGE_NAME: radarr

jobs:
  # Build une fois pour toutes les plateformes
  build-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Continue m√™me si une plateforme √©choue
      matrix:
        platform:
          - linux/amd64
          - linux/arm64/v8
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Prepare platform name
        id: prep
        run: |
          PLATFORM_PAIR=$(echo "${{ matrix.platform }}" | tr '/' '-')
          echo "platform-pair=$PLATFORM_PAIR" >> $GITHUB_OUTPUT
      
      - name: Extract Radarr version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.radarr_version }}" ]; then
            VERSION="${{ github.event.inputs.radarr_version }}"
          else
            VERSION=$(grep -oP 'RADARR_VERSION: \K[0-9.]+' .github/workflows/build-push.yml)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build for ${{ matrix.platform }}
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ matrix.platform }}
          load: false  # Ne pas charger, juste construire
          outputs: type=docker,dest=/tmp/radarr-${{ steps.prep.outputs.platform-pair }}.tar
          cache-from: type=gha,scope=${{ steps.prep.outputs.platform-pair }}
          cache-to: type=gha,mode=max,scope=${{ steps.prep.outputs.platform-pair }}
          build-args: |
            RADARR_VERSION=${{ steps.version.outputs.version }}
          tags: ${{ env.IMAGE_NAME }}:test-${{ steps.prep.outputs.platform-pair }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: radarr-${{ steps.prep.outputs.platform-pair }}
          path: /tmp/radarr-${{ steps.prep.outputs.platform-pair }}.tar
          retention-days: 1

  # Tests fonctionnels pour chaque plateforme
  test-matrix:
    needs: build-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Teste toutes les plateformes m√™me si une √©choue
      matrix:
        platform:
          - linux/amd64
          - linux/arm64/v8
          - linux/arm/v7
    
    steps:
      - name: Prepare platform name
        id: prep
        run: |
          PLATFORM_PAIR=$(echo "${{ matrix.platform }}" | tr '/' '-')
          echo "platform-pair=$PLATFORM_PAIR" >> $GITHUB_OUTPUT
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: radarr-${{ steps.prep.outputs.platform-pair }}
          path: /tmp
      
      - name: Load Docker image
        run: |
          docker load --input /tmp/radarr-${{ steps.prep.outputs.platform-pair }}.tar
      
      - name: Start Radarr container
        run: |
          docker run -d \
            --name radarr-test-${{ steps.prep.outputs.platform-pair }} \
            --platform ${{ matrix.platform }} \
            -e PUID=1000 \
            -e PGID=1000 \
            -e TZ=UTC \
            -p 7878:7878 \
            ${{ env.IMAGE_NAME }}:test-${{ steps.prep.outputs.platform-pair }}
      
      - name: Wait for Radarr to start
        run: |
          echo "‚è≥ Waiting for Radarr to start on ${{ matrix.platform }}..."
          
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -f http://localhost:7878 > /dev/null 2>&1; then
              echo "‚úÖ Radarr is responding!"
              break
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            sleep 2
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "‚ùå Radarr failed to start within timeout"
            docker logs radarr-test-${{ steps.prep.outputs.platform-pair }}
            exit 1
          fi
      
      - name: Test Web UI
        run: |
          echo "üß™ Testing Web UI accessibility..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:7878)
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Web UI is accessible (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Web UI returned unexpected code: $HTTP_CODE"
            exit 1
          fi
      
      - name: Get API Key
        id: api_key
        run: |
          # R√©cup√©rer la cl√© API depuis les logs ou le fichier de config
          API_KEY=$(docker exec radarr-test-${{ steps.prep.outputs.platform-pair }} \
            cat /config/config.xml | grep -oP '<ApiKey>\K[^<]+' || echo "")
          
          if [ -z "$API_KEY" ]; then
            echo "‚ö†Ô∏è No API key found yet, waiting..."
            sleep 5
            API_KEY=$(docker exec radarr-test-${{ steps.prep.outputs.platform-pair }} \
              cat /config/config.xml | grep -oP '<ApiKey>\K[^<]+' || echo "test")
          fi
          
          echo "api-key=$API_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ API Key retrieved"
      
      - name: Test API - System Status
        run: |
          echo "üß™ Testing /api/v3/system/status..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "X-Api-Key: ${{ steps.api_key.outputs.api-key }}" \
            http://localhost:7878/api/v3/system/status)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 401 ]; then
            echo "‚úÖ System status endpoint working (HTTP $HTTP_CODE)"
            echo "$BODY" | jq '.' || echo "$BODY"
          else
            echo "‚ùå System status failed (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi
      
      - name: Test API - Health Check
        run: |
          echo "üß™ Testing /api/v3/health..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "X-Api-Key: ${{ steps.api_key.outputs.api-key }}" \
            http://localhost:7878/api/v3/health)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 401 ]; then
            echo "‚úÖ Health endpoint working (HTTP $HTTP_CODE)"
            echo "$BODY" | jq '.' || echo "$BODY"
          else
            echo "‚ùå Health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi
      
      - name: Test API - Disk Space
        run: |
          echo "üß™ Testing /api/v3/diskspace..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "X-Api-Key: ${{ steps.api_key.outputs.api-key }}" \
            http://localhost:7878/api/v3/diskspace)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 401 ]; then
            echo "‚úÖ Disk space endpoint working (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Disk space check failed (HTTP $HTTP_CODE)"
            exit 1
          fi
      
      - name: Check container logs for errors
        run: |
          echo "üìã Checking logs for critical errors..."
          
          LOGS=$(docker logs radarr-test-${{ steps.prep.outputs.platform-pair }} 2>&1)
          
          # Recherche d'erreurs critiques
          if echo "$LOGS" | grep -i "fatal\|critical\|exception" | grep -v "Test"; then
            echo "‚ö†Ô∏è Warning: Found potential errors in logs"
            echo "$LOGS" | grep -i "fatal\|critical\|exception" | head -20
            # Ne pas faire √©chouer pour des warnings
          else
            echo "‚úÖ No critical errors found in logs"
          fi
      
      - name: Test container health
        run: |
          echo "üß™ Checking container health..."
          
          CONTAINER_STATUS=$(docker inspect \
            --format='{{.State.Status}}' \
            radarr-test-${{ steps.prep.outputs.platform-pair }})
          
          if [ "$CONTAINER_STATUS" = "running" ]; then
            echo "‚úÖ Container is healthy and running"
          else
            echo "‚ùå Container is not running (Status: $CONTAINER_STATUS)"
            exit 1
          fi
      
      - name: Performance test
        run: |
          echo "‚ö° Testing response times..."
          
          START=$(date +%s%N)
          curl -s -H "X-Api-Key: ${{ steps.api_key.outputs.api-key }}" \
            http://localhost:7878/api/v3/system/status > /dev/null
          END=$(date +%s%N)
          
          DURATION=$(( (END - START) / 1000000 ))
          echo "Response time: ${DURATION}ms"
          
          if [ $DURATION -lt 5000 ]; then
            echo "‚úÖ Response time is acceptable"
          else
            echo "‚ö†Ô∏è Warning: Response time is slow (${DURATION}ms)"
          fi
      
      - name: Show container info
        if: always()
        run: |
          echo "üìä Container information:"
          docker ps -a | grep radarr-test || true
          docker stats --no-stream radarr-test-${{ steps.prep.outputs.platform-pair }} || true
      
      - name: Cleanup
        if: always()
        run: |
          docker stop radarr-test-${{ steps.prep.outputs.platform-pair }} || true
          docker rm radarr-test-${{ steps.prep.outputs.platform-pair }} || true
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ steps.prep.outputs.platform-pair }}
          path: |
            /tmp/radarr-test-logs-*.txt
          retention-days: 7

  # Job de synth√®se qui bloque si un test √©choue
  test-summary:
    needs: test-matrix
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-matrix.result }}" != "success" ]; then
            echo "‚ùå Tests failed on one or more platforms!"
            echo "Check the logs above for details."
            exit 1
          else
            echo "‚úÖ All platform tests passed successfully!"
          fi
      
      - name: Post summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const result = '${{ needs.test-matrix.result }}';
            const icon = result === 'success' ? '‚úÖ' : '‚ùå';
            const status = result === 'success' ? 'passed' : 'failed';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${icon} **Multi-platform tests ${status}**\n\nAll architectures (amd64, arm64, arm/v7) have been tested.\n\nPlatforms tested:\n- linux/amd64\n- linux/arm64/v8\n- linux/arm/v7`
            });
